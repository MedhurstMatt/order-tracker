<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Order Tracker with Supabase and Staff Login</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      color: #2c3e50;
      margin-bottom: 10px;
    }
    hr {
      border: 0;
      height: 1px;
      background: #ddd;
      margin: 20px 0;
    }
    input[type="text"], textarea, select { 
      width: 100%;
      padding: 8px;
      margin: 6px 0 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; 
    }
    button {
      padding: 8px 16px;
      margin: 4px 2px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s ease;
    }
    button:hover {
      background-color: #2980b9;
    }
    .btn-group button {
      margin-right: 5px;
    }
    .employee-login, .new-order, .filter-section, .orders-section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
  <!-- Include Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase with your credentials
    const supabaseUrl = "https://mkuxuegawofzedmxhxhu.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1rdXh1ZWdhd29memVkbXhoeGh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEyMzc2NjQsImV4cCI6MjA1NjgxMzY2NH0.MsnFEpPYJrD5-BO7W0csjwPog5heW4hH5Dz7ts2rKr4";
    const supabase = createClient(supabaseUrl, supabaseKey);
  </script>
</head>
<body>
  <h1>Order Tracker</h1>

  <!-- Employee Login Section with Staff List -->
  <div class="employee-login">
    <h2>Employee Login</h2>
    <select id="employeeNameSelect">
      <option value="">Select Employee</option>
      <option value="Allan Bakker">Allan Bakker</option>
      <option value="Anne McShane">Anne McShane</option>
      <option value="Cathy Mayne">Cathy Mayne</option>
      <option value="Colin Chung">Colin Chung</option>
      <option value="Elaine Killalea">Elaine Killalea</option>
      <option value="Fergus McShane">Fergus McShane</option>
      <option value="Garry Williams">Garry Williams</option>
      <option value="Hamish Killalea">Hamish Killalea</option>
      <option value="Matthew Tonks">Matthew Tonks</option>
      <option value="Matthew Tracey">Matthew Tracey</option>
      <option value="Paul Tickner">Paul Tickner</option>
      <option value="Richard Medhurst">Richard Medhurst</option>
      <option value="Toby McShane">Toby McShane</option>
    </select>
    <button id="setEmployeeBtn">Set Employee</button>
    <p id="loggedEmployee"></p>
  </div>
  <hr>

  <!-- New Order Form -->
  <div class="new-order">
    <h2>Add New Order</h2>
    <form id="orderForm">
      <label for="title">Order Title:</label>
      <input type="text" id="title" required>
      <label for="notes">Notes:</label>
      <textarea id="notes"></textarea>
      <button type="submit">Add Order</button>
    </form>
  </div>
  <hr>

  <!-- Filter Section -->
  <div class="filter-section">
    <h2>Filter Orders</h2>
    <label for="filterStatus">Filter by Status:</label>
    <select id="filterStatus">
      <option value="all">All</option>
      <option value="to be ordered">to be ordered</option>
      <option value="on order">on order</option>
      <option value="awaiting order">awaiting order</option>
      <option value="store pick up">store pick up</option>
      <option value="warehouse pick up">warehouse pick up</option>
      <option value="delivery request">delivery request</option>
      <option value="freight forward">freight forward</option>
      <option value="completed">completed</option>
      <option value="canceled">canceled</option>
    </select>
  </div>
  <hr>

  <!-- Orders Table -->
  <div class="orders-section">
    <h2>Current Orders</h2>
    <table id="ordersTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Notes</th>
          <th>Status</th>
          <th>Employee</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Orders will be inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    /*************** Employee Login Code ***************/
    let currentEmployee = "";
    function setEmployee() {
      const employeeSelect = document.getElementById("employeeNameSelect");
      const selectedEmployee = employeeSelect.value;
      if (selectedEmployee !== "") {
        currentEmployee = selectedEmployee;
        localStorage.setItem("employeeName", currentEmployee);
        updateEmployeeDisplay();
      } else {
        alert("Please select a valid employee.");
      }
    }
    function updateEmployeeDisplay() {
      document.getElementById("loggedEmployee").textContent = "Logged in as: " + (currentEmployee || "None");
    }
    document.getElementById("setEmployeeBtn").addEventListener("click", setEmployee);

    /*************** Order Tracker Code Using Supabase ***************/
    const statuses = [
      "to be ordered",
      "on order",
      "awaiting order",
      "store pick up",
      "warehouse pick up",
      "delivery request",
      "freight forward",
      "completed",
      "canceled"
    ];

    let orders = [];

    // Render orders from Supabase data
    function renderOrders() {
      const filter = document.getElementById("filterStatus").value;
      const tbody = document.getElementById("ordersTable").querySelector("tbody");
      tbody.innerHTML = "";
      orders.forEach(order => {
        if (filter !== "all" && order.status !== filter) return;
        const isEditable = (order.status !== "completed" && order.status !== "canceled");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${order.id}</td>
          <td>${order.title}</td>
          <td>
            <textarea onchange="updateNotes(${order.id}, this.value)" ${isEditable ? "" : "disabled"}>${order.notes || ""}</textarea>
          </td>
          <td>
            <select onchange="updateStatus(${order.id}, this.value)" ${isEditable ? "" : "disabled"}>
              ${statuses.filter(s => s !== "canceled").map(status => `<option value="${status}" ${order.status === status ? "selected" : ""}>${status}</option>`).join("")}
            </select>
          </td>
          <td>${order.employee || "N/A"}</td>
          <td>
            ${isEditable ? `<button onclick="advanceStatus(${order.id})">Next Step</button>
            <button onclick="cancelOrder(${order.id})">Cancel</button>` : ""}
            <button onclick="deleteOrder(${order.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Load orders from Supabase
    async function loadOrders() {
      const { data, error } = await supabase
        .from("orders")
        .select("*")
        .order("timestamp", { ascending: false });
      if (error) {
        console.error("Error loading orders:", error);
      } else {
        orders = data;
        renderOrders();
      }
    }

    // Add a new order to Supabase
    async function addOrder(order) {
      const { data, error } = await supabase
        .from("orders")
        .insert(order);
      if (error) {
        console.error("Error adding order:", error);
      } else {
        loadOrders();
      }
    }

    // Update order notes in Supabase
    async function updateNotes(id, newNotes) {
      const { error } = await supabase
        .from("orders")
        .update({ notes: newNotes })
        .eq("id", id);
      if (error) console.error("Error updating notes:", error);
      else loadOrders();
    }

    // Update order status in Supabase
    async function updateStatus(id, newStatus) {
      const { error } = await supabase
        .from("orders")
        .update({ status: newStatus })
        .eq("id", id);
      if (error) console.error("Error updating status:", error);
      else loadOrders();
    }

    // Advance order status to the next step
    async function advanceStatus(id) {
      const order = orders.find(o => o.id === id);
      if (!order) return;
      const currentIndex = statuses.indexOf(order.status);
      if (currentIndex >= 0 && currentIndex < statuses.indexOf("completed")) {
        const { error } = await supabase
          .from("orders")
          .update({ status: statuses[currentIndex + 1] })
          .eq("id", id);
        if (error) console.error("Error advancing status:", error);
        else loadOrders();
      }
    }

    // Cancel an order by setting its status to "canceled"
    async function cancelOrder(id) {
      const { error } = await supabase
        .from("orders")
        .update({ status: "canceled" })
        .eq("id", id);
      if (error) console.error("Error canceling order:", error);
      else loadOrders();
    }

    // Delete order with password protection (password: 216521)
    async function deleteOrder(id) {
      const pwd = prompt("Enter delete password:");
      if (pwd === null) return;
      if (pwd !== "216521") {
        alert("Incorrect password. Deletion aborted.");
        return;
      }
      if (confirm("Are you sure you want to permanently delete this order?")) {
        const { error } = await supabase
          .from("orders")
          .delete()
          .eq("id", id);
        if (error) console.error("Error deleting order:", error);
        else loadOrders();
      }
    }

    // Add new order on form submit
    document.getElementById("orderForm").addEventListener("submit", function(e) {
      e.preventDefault();
      if (!currentEmployee) {
        alert("Please set your employee from the list.");
        return;
      }
      const title = document.getElementById("title").value;
      const notes = document.getElementById("notes").value;
      const order = {
        title: title,
        notes: notes,
        status: statuses[0],  // "to be ordered"
        employee: currentEmployee,
        timestamp: new Date().toISOString()
      };
      addOrder(order);
      this.reset();
    });

    document.getElementById("filterStatus").addEventListener("change", renderOrders);

    // On page load, restore employee from localStorage and load orders
    window.addEventListener("load", function() {
      const storedEmployee = localStorage.getItem("employeeName");
      if (storedEmployee) currentEmployee = storedEmployee;
      updateEmployeeDisplay();
      loadOrders();
    });
  </script>
</body>
</html>
